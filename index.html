<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GestorFatura</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; user-select: none; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col md:flex-row overflow-hidden bg-gray-50">

    <!-- Sidebar / Navegação Mobile -->
    <nav class="bg-white md:w-64 md:h-full border-r border-gray-200 flex-shrink-0 flex md:flex-col justify-between z-20 shadow-sm md:shadow-none">
        <div class="p-4 md:p-6 flex items-center md:block justify-between w-full">
            <h1 class="text-2xl font-bold text-indigo-600 tracking-tight flex items-center gap-2">
                <i class="fa-solid fa-credit-card"></i> GestorFatura
            </h1>
            <button id="mobileMenuBtn" class="md:hidden text-gray-500 hover:text-indigo-600 p-2">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </div>

        <div id="navMenu" class="hidden md:flex flex-col flex-1 p-4 gap-2 absolute md:relative top-16 md:top-0 left-0 w-full bg-white md:bg-transparent shadow-lg md:shadow-none pb-4 md:pb-0 z-30">
            <button onclick="switchTab('dashboard')" class="nav-btn active flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-white bg-indigo-600 transition-colors">
                <i class="fa-solid fa-chart-pie w-5"></i> Visão Geral
            </button>
            <button onclick="switchTab('transactions')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i class="fa-solid fa-list w-5"></i> Transações
            </button>
            <button onclick="switchTab('people')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i class="fa-solid fa-users w-5"></i> Terceiros
            </button>
            <button onclick="switchTab('config')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                <i class="fa-solid fa-cog w-5"></i> Configurações
            </button>
        </div>
        
        <div class="p-4 text-xs text-gray-400 text-center hidden md:block">
            PWA v2.1 • Import Ready
        </div>
    </nav>

    <!-- Área Principal -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden relative w-full flex flex-col" id="mainContent">
        
        <!-- Header Superior -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10 px-4 py-3 md:px-6 md:py-4 flex flex-col md:flex-row justify-between items-center gap-3 shadow-sm">
            
            <!-- Seletor de Cartão -->
            <div class="w-full md:w-auto">
                <select id="globalCardFilter" onchange="renderAll()" class="w-full md:w-48 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                    <option value="all">Todos os Cartões</option>
                    <!-- JS preenche cartões aqui -->
                </select>
            </div>

            <!-- Seletor de Data -->
            <div class="flex items-center bg-gray-100 rounded-lg p-1 shadow-inner">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-white rounded-md text-gray-600 hover:text-indigo-600 transition shadow-sm hover:shadow">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <span id="currentDateDisplay" class="mx-2 md:mx-4 font-semibold text-gray-700 min-w-[120px] md:min-w-[140px] text-center text-sm md:text-base select-none">
                    ---
                </span>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-white rounded-md text-gray-600 hover:text-indigo-600 transition shadow-sm hover:shadow">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
            
            <button onclick="openModal()" class="hidden md:flex bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium gap-2 items-center transition shadow-lg shadow-indigo-200">
                <i class="fa-solid fa-plus"></i> Nova Despesa
            </button>
        </header>

        <!-- Conteúdo das Abas -->
        <div class="p-4 md:p-8 max-w-7xl mx-auto w-full pb-24 md:pb-8 flex-1">

            <!-- ABA DASHBOARD -->
            <div id="tab-dashboard" class="tab-content space-y-6">
                <!-- Cards Resumo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <!-- Fatura Total -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-4 opacity-10 text-indigo-600">
                            <i class="fa-solid fa-file-invoice-dollar text-6xl"></i>
                        </div>
                        <p class="text-xs md:text-sm text-gray-500 font-medium uppercase">Fatura Atual</p>
                        <h3 id="totalInvoice" class="text-2xl md:text-3xl font-bold text-gray-800 mt-1 md:mt-2">R$ 0,00</h3>
                        <div class="mt-2 text-xs text-gray-400 flex justify-between items-center">
                            <span id="limitDisplay">Limite: R$ 0,00</span>
                            <span id="limitPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1 mt-1">
                            <div id="limitBar" class="bg-indigo-500 h-1 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Meus Gastos -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-4 opacity-10 text-emerald-600">
                            <i class="fa-solid fa-wallet text-6xl"></i>
                        </div>
                        <p class="text-xs md:text-sm text-gray-500 font-medium uppercase">Meus Gastos</p>
                        <h3 id="totalPersonal" class="text-2xl md:text-3xl font-bold text-gray-800 mt-1 md:mt-2">R$ 0,00</h3>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-4">
                            <div id="personalBar" class="bg-emerald-500 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Terceiros -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-4 opacity-10 text-orange-500">
                            <i class="fa-solid fa-hand-holding-dollar text-6xl"></i>
                        </div>
                        <p class="text-xs md:text-sm text-gray-500 font-medium uppercase">A Receber</p>
                        <h3 id="totalOthers" class="text-2xl md:text-3xl font-bold text-orange-600 mt-1 md:mt-2">R$ 0,00</h3>
                        <p class="text-xs text-orange-400 mt-2">Dívidas de terceiros</p>
                    </div>
                </div>

                <!-- Detalhamento -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Lista de Devedores -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-1">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center justify-between">
                            <span>Divisão por Pessoa</span>
                            <i class="fa-solid fa-users text-gray-400"></i>
                        </h4>
                        <div id="peopleListSummary" class="space-y-3 max-h-60 overflow-y-auto no-scrollbar">
                            <!-- JS -->
                        </div>
                    </div>

                    <!-- Top Gastos -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                        <h4 class="font-semibold text-gray-700 mb-4 flex items-center justify-between">
                            <span>Maiores Gastos</span>
                            <button onclick="switchTab('transactions')" class="text-xs text-indigo-600 hover:underline">Ver tudo</button>
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">Descrição</th>
                                        <th class="px-4 py-3">Cartão</th>
                                        <th class="px-4 py-3 text-right rounded-r-lg">Valor</th>
                                    </tr>
                                </thead>
                                <tbody id="topExpensesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA TRANSAÇÕES -->
            <div id="tab-transactions" class="tab-content hidden space-y-6">
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="font-bold text-lg text-gray-700">Extrato</h3>
                        <input type="text" id="searchInput" placeholder="Buscar..." class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full md:w-48 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                                <tr>
                                    <th class="px-3 py-3">Dia</th>
                                    <th class="px-3 py-3">Desc</th>
                                    <th class="px-3 py-3">Quem</th>
                                    <th class="px-3 py-3 text-center">Parc.</th>
                                    <th class="px-3 py-3 text-right">Valor</th>
                                    <th class="px-3 py-3 text-center"><i class="fa-solid fa-trash"></i></th>
                                </tr>
                            </thead>
                            <tbody id="fullTransactionsTable" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ABA PESSOAS -->
            <div id="tab-people" class="tab-content hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                    <h3 class="font-bold text-lg text-gray-700 mb-4">Gerenciar Pessoas</h3>
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="newPersonName" placeholder="Nome..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                        <button onclick="addPerson()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Add</button>
                    </div>
                    <ul id="peopleListManage" class="divide-y divide-gray-100"></ul>
                </div>
            </div>

            <!-- ABA CONFIG (Cartões e Dados) -->
            <div id="tab-config" class="tab-content hidden space-y-6">
                
                <!-- Gerenciar Cartões -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                    <h3 class="font-bold text-lg text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-credit-card text-indigo-500"></i> Meus Cartões
                    </h3>
                    
                    <form onsubmit="handleAddCard(event)" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="col-span-2 md:col-span-4">
                            <label class="text-xs font-semibold text-gray-500">Nome do Cartão</label>
                            <input type="text" name="cardName" required placeholder="Ex: Nubank, Visa" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500">Fechamento (Dia)</label>
                            <input type="number" name="closingDay" min="1" max="31" required placeholder="Ex: 5" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500">Vencimento (Dia)</label>
                            <input type="number" name="dueDay" min="1" max="31" required placeholder="Ex: 12" class="w-full border rounded p-2 text-sm">
                        </div>
                         <div class="col-span-2 md:col-span-2">
                            <label class="text-xs font-semibold text-gray-500">Limite (R$)</label>
                            <div class="flex gap-2">
                                <input type="number" name="limit" required placeholder="Ex: 5000" class="w-full border rounded p-2 text-sm">
                                <button type="submit" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </form>

                    <div id="cardsList" class="space-y-3">
                        <!-- JS renders cards here -->
                    </div>
                </div>

                <!-- Dados do App -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                    <h3 class="font-bold text-lg text-gray-700 mb-4">Dados</h3>
                    <div class="space-y-3">
                        <button onclick="exportData()" class="w-full text-left p-3 rounded hover:bg-gray-50 border flex justify-between items-center text-sm text-gray-700">
                            <span><i class="fa-solid fa-download mr-2"></i> Backup (JSON)</span>
                        </button>
                        
                        <!-- BOTÃO DE IMPORTAR -->
                        <button onclick="document.getElementById('importFile').click()" class="w-full text-left p-3 rounded hover:bg-gray-50 border flex justify-between items-center text-sm text-gray-700">
                            <span><i class="fa-solid fa-upload mr-2"></i> Restaurar Backup</span>
                        </button>
                        <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImport(event)">

                        <button onclick="clearAllData()" class="w-full text-left p-3 rounded hover:bg-red-50 border border-red-100 flex justify-between items-center text-sm text-red-600">
                            <span><i class="fa-solid fa-trash mr-2"></i> Resetar Tudo</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- FAB Mobile -->
    <button onclick="openModal()" class="md:hidden fixed bottom-20 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 hover:scale-105 transition-transform">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- MODAL: NOVA TRANSAÇÃO -->
    <div id="transactionModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-[fadeIn_0.2s_ease-out]">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Nova Despesa</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="transactionForm" onsubmit="handleTransactionSubmit(event)" class="p-6 space-y-4">
                
                <!-- Tipo -->
                <div class="grid grid-cols-2 gap-2 bg-gray-100 p-1 rounded-lg">
                    <label class="cursor-pointer text-center">
                        <input type="radio" name="type" value="one-time" class="peer hidden" checked onchange="toggleInstallmentField()">
                        <div class="py-2 text-sm font-medium text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Única</div>
                    </label>
                    <label class="cursor-pointer text-center">
                        <input type="radio" name="type" value="installment" class="peer hidden" onchange="toggleInstallmentField()">
                        <div class="py-2 text-sm font-medium text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">Parcelada</div>
                    </label>
                    <label class="cursor-pointer text-center col-span-2 mt-1">
                        <input type="radio" name="type" value="subscription" class="peer hidden" onchange="toggleInstallmentField()">
                        <div class="py-1 text-xs font-medium text-gray-500 rounded-md peer-checked:text-purple-600 transition-all flex items-center justify-center gap-1">
                            <i class="fa-solid fa-repeat"></i> Assinatura
                        </div>
                    </label>
                </div>

                <!-- Descrição -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Descrição</label>
                    <input type="text" name="description" required placeholder="O que você comprou?" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Valor e Parcelas -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Valor (R$)</label>
                        <input type="number" step="0.01" name="amount" required placeholder="0,00" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div id="installmentField" class="hidden">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Parcelas</label>
                        <input type="number" name="installments" min="2" max="48" value="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <!-- Data e Cartão -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" name="date" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Cartão</label>
                        <select name="cardId" id="modalCardSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- JS -->
                        </select>
                    </div>
                </div>

                <!-- Quem Comprou -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Responsável (Quem paga?)</label>
                    <select id="modalPersonSelect" name="person" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                        <!-- JS -->
                    </select>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg shadow-lg shadow-indigo-200 transition-all active:scale-95">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('PWA Service Worker registrado'))
                    .catch(err => console.log('Falha no SW:', err));
            });
        }

        // --- ESTADO ---
        let state = {
            transactions: [],
            people: ['Eu'],
            cards: [], // { id, name, closingDay, dueDay, limit }
            viewDate: new Date(),
            currentTab: 'dashboard',
            selectedCardFilter: 'all' // 'all' or cardId
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- PERSISTÊNCIA ---
            if (navigator.storage && navigator.storage.persist) {
                navigator.storage.persist().then(granted => {
                    console.log(granted ? "Persistência ativada" : "Persistência não garantida");
                });
            }

            loadData();
            
            // Default Card se não existir
            if (state.cards.length === 0) {
                state.cards.push({ id: 'default', name: 'Meu Cartão', closingDay: 1, dueDay: 10, limit: 1000 });
                saveData();
            }

            // Set inputs
            document.querySelector('input[name="date"]').value = new Date().toISOString().split('T')[0];

            updateDateDisplay();
            renderAll();
        });

        // --- LÓGICA DE DATAS E FATURA ---
        function getFirstInstallmentDate(purchaseDateStr, closingDay) {
            const pDate = new Date(purchaseDateStr);
            const purchaseDay = pDate.getUTCDate();
            const purchaseMonth = pDate.getUTCMonth();
            const purchaseYear = pDate.getUTCFullYear();

            let targetMonth = purchaseMonth;
            let targetYear = purchaseYear;

            // Se comprou no dia do fechamento ou depois, fatura só no próximo mês
            if (purchaseDay >= parseInt(closingDay)) {
                targetMonth++;
                if (targetMonth > 11) {
                    targetMonth = 0;
                    targetYear++;
                }
            }

            return { month: targetMonth, year: targetYear };
        }

        function getTransactionDetailsForMonth(transaction, viewDate) {
            const card = state.cards.find(c => c.id === transaction.cardId) || state.cards[0];
            if (!card) return { isActive: false }; 

            const firstBill = getFirstInstallmentDate(transaction.date, card.closingDay);
            
            const vMonth = viewDate.getMonth();
            const vYear = viewDate.getFullYear();

            const monthDiff = (vYear - firstBill.year) * 12 + (vMonth - firstBill.month);

            let isActive = false;
            let currentInstallment = '';
            let installmentAmount = 0;

            if (transaction.type === 'subscription') {
                if (monthDiff >= 0) {
                    isActive = true;
                    installmentAmount = transaction.amount;
                    currentInstallment = 'Assinatura';
                }
            } else {
                const totalInstallments = transaction.type === 'one-time' ? 1 : transaction.installments;
                if (monthDiff >= 0 && monthDiff < totalInstallments) {
                    isActive = true;
                    currentInstallment = `${monthDiff + 1}/${totalInstallments}`;
                    installmentAmount = transaction.amount / totalInstallments;
                }
            }

            return { isActive, currentInstallment, installmentAmount, cardName: card.name };
        }

        // --- RENDER ---
        function renderAll() {
            renderCardSelects();
            renderDashboard();
            renderPeopleList();
            renderConfigCards();
        }

        function renderCardSelects() {
            const globalFilter = document.getElementById('globalCardFilter');
            const currentVal = state.selectedCardFilter;
            globalFilter.innerHTML = `<option value="all">Todos os Cartões</option>`;
            state.cards.forEach(c => { globalFilter.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
            globalFilter.value = currentVal;

            const modalSelect = document.getElementById('modalCardSelect');
            modalSelect.innerHTML = '';
            state.cards.forEach(c => { modalSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        }

        function renderDashboard() {
            const globalFilter = document.getElementById('globalCardFilter').value;
            state.selectedCardFilter = globalFilter;

            let totalInvoice = 0;
            let totalPersonal = 0;
            let totalOthers = 0;
            let totalLimit = 0;
            
            if (globalFilter === 'all') {
                totalLimit = state.cards.reduce((acc, c) => acc + parseFloat(c.limit), 0);
            } else {
                const c = state.cards.find(x => x.id === globalFilter);
                totalLimit = c ? parseFloat(c.limit) : 0;
            }

            const debtsByPerson = {};
            state.people.forEach(p => { if(p !== 'Eu') debtsByPerson[p] = 0; });

            const activeTransactions = [];

            state.transactions.forEach(t => {
                if (globalFilter !== 'all' && t.cardId !== globalFilter) return;

                const details = getTransactionDetailsForMonth(t, state.viewDate);
                if (details.isActive) {
                    const amount = details.installmentAmount;
                    totalInvoice += amount;
                    if (t.person === 'Eu') {
                        totalPersonal += amount;
                    } else {
                        totalOthers += amount;
                        if (!debtsByPerson[t.person]) debtsByPerson[t.person] = 0;
                        debtsByPerson[t.person] += amount;
                    }
                    activeTransactions.push({ ...t, displayInstallment: details.currentInstallment, displayAmount: amount, cardName: details.cardName });
                }
            });

            document.getElementById('totalInvoice').textContent = formatMoney(totalInvoice);
            document.getElementById('totalPersonal').textContent = formatMoney(totalPersonal);
            document.getElementById('totalOthers').textContent = formatMoney(totalOthers);
            
            document.getElementById('limitDisplay').textContent = `Limite: ${formatMoney(totalLimit)}`;
            const limitPercent = totalLimit > 0 ? Math.min((totalInvoice / totalLimit) * 100, 100) : 0;
            document.getElementById('limitBar').style.width = `${limitPercent}%`;
            document.getElementById('limitBar').className = `h-1 rounded-full ${limitPercent > 90 ? 'bg-red-500' : 'bg-indigo-500'}`;
            document.getElementById('limitPercent').textContent = `${Math.round(limitPercent)}%`;

            const peopleEl = document.getElementById('peopleListSummary');
            peopleEl.innerHTML = '';
            Object.entries(debtsByPerson).forEach(([name, val]) => {
                if(val > 0) {
                    peopleEl.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-100 text-sm">
                            <span class="font-medium text-gray-700">${name}</span>
                            <span class="font-bold text-orange-600">${formatMoney(val)}</span>
                        </div>`;
                }
            });
            if(peopleEl.innerHTML === '') peopleEl.innerHTML = '<div class="text-gray-400 text-xs text-center py-2">Ninguém deve nada.</div>';

            activeTransactions.sort((a, b) => b.displayAmount - a.displayAmount);
            const topTable = document.getElementById('topExpensesTable');
            topTable.innerHTML = '';
            activeTransactions.slice(0, 5).forEach(t => {
                topTable.innerHTML += `
                    <tr class="bg-white border-b">
                        <td class="px-4 py-2 font-medium truncate max-w-[120px]">${t.description}</td>
                        <td class="px-4 py-2 text-xs text-gray-500">${t.cardName}</td>
                        <td class="px-4 py-2 text-right font-bold text-gray-700">${formatMoney(t.displayAmount)}</td>
                    </tr>`;
            });

            renderTransactionsTab(activeTransactions);
        }

        function renderTransactionsTab(activeTransactions) {
            const table = document.getElementById('fullTransactionsTable');
            table.innerHTML = '';
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = activeTransactions.filter(t => t.description.toLowerCase().includes(term) || t.person.toLowerCase().includes(term));

            if(filtered.length === 0) {
                table.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-400">Nada aqui.</td></tr>';
                return;
            }

            filtered.forEach(t => {
                const day = new Date(t.date).getUTCDate().toString().padStart(2, '0');
                table.innerHTML += `
                    <tr class="bg-white hover:bg-gray-50 transition">
                        <td class="px-3 py-3 text-gray-500">${day}</td>
                        <td class="px-3 py-3 font-medium">
                            <div class="text-gray-900">${t.description}</div>
                            <div class="text-xs text-gray-400">${t.cardName}</div>
                        </td>
                        <td class="px-3 py-3"><span class="px-2 py-0.5 rounded text-xs ${t.person==='Eu'?'bg-emerald-100 text-emerald-800':'bg-orange-100 text-orange-800'}">${t.person}</span></td>
                        <td class="px-3 py-3 text-center text-xs text-gray-500">${t.displayInstallment}</td>
                        <td class="px-3 py-3 text-right font-bold text-gray-700">${formatMoney(t.displayAmount)}</td>
                        <td class="px-3 py-3 text-center"><button onclick="deleteTransaction('${t.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `;
            });
        }

        // --- CARDS ---
        function renderConfigCards() {
            const list = document.getElementById('cardsList');
            list.innerHTML = '';
            state.cards.forEach(c => {
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200">
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${c.name}</div>
                            <div class="text-xs text-gray-500">Fecha dia ${c.closingDay} • Vence dia ${c.dueDay}</div>
                            <div class="text-xs text-indigo-600 font-mono mt-1">Limite: ${formatMoney(parseFloat(c.limit))}</div>
                        </div>
                        <button onclick="deleteCard('${c.id}')" class="text-red-400 hover:text-red-600 p-2" ${state.cards.length === 1 ? 'disabled style="opacity:0.3"' : ''}>
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            });
        }

        function handleAddCard(e) {
            e.preventDefault();
            const form = e.target;
            state.cards.push({
                id: Date.now().toString(),
                name: form.cardName.value,
                closingDay: parseInt(form.closingDay.value),
                dueDay: parseInt(form.dueDay.value),
                limit: parseFloat(form.limit.value)
            });
            saveData(); form.reset(); renderAll();
        }

        function deleteCard(id) {
            if (state.cards.length <= 1) return alert('Você precisa ter pelo menos um cartão.');
            if(state.transactions.some(t => t.cardId === id)) return alert('Apague as despesas deste cartão primeiro.');
            if(confirm('Remover este cartão?')) { state.cards = state.cards.filter(c => c.id !== id); saveData(); renderAll(); }
        }

        // --- GENERIC ---
        function switchTab(id) {
            state.currentTab = id;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.className = btn.className.replace('bg-indigo-600 text-white', 'text-gray-600 hover:bg-gray-50'));
            const active = document.querySelector(`button[onclick="switchTab('${id}')"]`);
            if(active) active.className = active.className.replace('text-gray-600 hover:bg-gray-50', 'bg-indigo-600 text-white');
            
            document.getElementById('navMenu').classList.add('hidden');
        }

        document.getElementById('mobileMenuBtn').addEventListener('click', () => { document.getElementById('navMenu').classList.toggle('hidden'); });

        function changeMonth(offset) { state.viewDate.setMonth(state.viewDate.getMonth() + offset); updateDateDisplay(); renderAll(); }
        function updateDateDisplay() {
            const str = state.viewDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('currentDateDisplay').textContent = str.charAt(0).toUpperCase() + str.slice(1);
        }
        function formatMoney(val) { return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

        // --- PEOPLE & MODAL ---
        function renderPeopleList() {
            const sel = document.getElementById('modalPersonSelect');
            sel.innerHTML = '';
            state.people.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);

            const list = document.getElementById('peopleListManage');
            list.innerHTML = '';
            state.people.forEach(p => {
                if(p !== 'Eu') {
                    list.innerHTML += `
                        <li class="flex justify-between p-3 hover:bg-gray-50 border-b text-sm">
                            <span>${p}</span>
                            <button onclick="removePerson('${p}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </li>`;
                }
            });
        }
        function addPerson() {
            const val = document.getElementById('newPersonName').value.trim();
            if(val && !state.people.includes(val)) { state.people.push(val); saveData(); renderPeopleList(); document.getElementById('newPersonName').value = ''; }
        }
        function removePerson(name) {
            if(confirm('Remover pessoa?')) { state.people = state.people.filter(p => p !== name); saveData(); renderPeopleList(); }
        }

        function openModal() { document.getElementById('transactionModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('transactionModal').classList.add('hidden'); document.getElementById('transactionForm').reset(); }
        function toggleInstallmentField() {
            const type = document.querySelector('input[name="type"]:checked').value;
            const field = document.getElementById('installmentField');
            type === 'installment' ? field.classList.remove('hidden') : field.classList.add('hidden');
        }

        function handleTransactionSubmit(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            state.transactions.push({
                id: Date.now().toString(),
                type: f.get('type'),
                description: f.get('description'),
                amount: parseFloat(f.get('amount')),
                installments: f.get('type') === 'installment' ? parseInt(f.get('installments')) : 1,
                date: f.get('date'),
                cardId: f.get('cardId'),
                person: f.get('person')
            });
            saveData(); closeModal(); renderAll();
        }
        function deleteTransaction(id) {
            if(confirm('Apagar?')) { state.transactions = state.transactions.filter(t => t.id !== id); saveData(); renderAll(); }
        }

        // --- STORAGE & IMPORT/EXPORT ---
        function saveData() { localStorage.setItem('gestorPWA_v2', JSON.stringify({ transactions: state.transactions, people: state.people, cards: state.cards })); }
        function loadData() {
            const d = JSON.parse(localStorage.getItem('gestorPWA_v2') || '{}');
            state.transactions = d.transactions || [];
            state.people = d.people || ['Eu'];
            state.cards = d.cards || [];
        }
        function clearAllData() {
            if(confirm('Isso apagará tudo.')) { localStorage.removeItem('gestorPWA_v2'); location.reload(); }
        }
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            a.download = "gestor_backup.json";
            a.click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Validação simples
                    if (!data.transactions || !data.cards) throw new Error('Arquivo JSON inválido ou incompleto.');

                    if (confirm(`Restaurar backup com ${data.transactions.length} transações? Dados atuais serão substituídos.`)) {
                        state.transactions = data.transactions;
                        state.people = data.people || ['Eu'];
                        state.cards = data.cards;
                        saveData();
                        renderAll();
                        alert('Backup restaurado com sucesso!');
                    }
                } catch (err) {
                    alert('Erro ao importar: ' + err.message);
                }
                event.target.value = ''; // Limpar input
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
