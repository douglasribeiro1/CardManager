<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GestorFatura Cloud</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; user-select: none; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden bg-gray-50">

    <!-- TELA DE LOGIN -->
    <div id="loginScreen" class="fixed inset-0 z-50 bg-gradient-to-br from-indigo-900 to-slate-900 flex flex-col items-center justify-center p-6 text-white hidden">
        <div class="w-full max-w-sm bg-white/10 backdrop-blur-lg p-8 rounded-2xl border border-white/20 shadow-2xl text-center">
            <div class="mb-6 bg-indigo-500 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto shadow-lg shadow-indigo-500/50">
                <i class="fa-solid fa-credit-card text-3xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">GestorFatura</h1>
            <p class="text-indigo-200 text-sm mb-8">Login seguro com Google.</p>
            
            <button onclick="loginWithGoogle()" class="w-full bg-white text-gray-800 font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-gray-50 active:scale-95 transition-all flex items-center justify-center gap-3">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Entrar com Google
            </button>
            <p id="loginStatus" class="mt-4 text-xs text-indigo-300 min-h-[20px]"></p>
        </div>
    </div>

    <!-- APP LOADING -->
    <div id="appLoading" class="fixed inset-0 z-40 bg-white flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-gray-500 text-xs font-medium">Sincronizando...</p>
    </div>

    <!-- APP CONTENT -->
    <div id="appContent" class="hidden flex-1 flex flex-col md:flex-row h-full overflow-hidden">
        
        <!-- Sidebar -->
        <nav class="bg-white md:w-64 md:h-full border-r border-gray-200 flex-shrink-0 flex md:flex-col justify-between z-20 shadow-sm">
            <div class="p-4 md:p-6 flex items-center md:block justify-between w-full">
                <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                    <i class="fa-solid fa-cloud"></i> GestorFatura
                </h1>
                <button id="mobileMenuBtn" class="md:hidden text-gray-500"><i class="fa-solid fa-bars text-xl"></i></button>
            </div>

            <div id="navMenu" class="hidden md:flex flex-col flex-1 p-4 gap-2 absolute md:relative top-16 md:top-0 left-0 w-full bg-white md:bg-transparent shadow-lg md:shadow-none pb-4 md:pb-0 z-30">
                <button onclick="switchTab('dashboard')" class="nav-btn active flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-white bg-indigo-600"><i class="fa-solid fa-chart-pie w-5"></i> Vis√£o Geral</button>
                <button onclick="switchTab('transactions')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-list w-5"></i> Transa√ß√µes</button>
                <button onclick="switchTab('people')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-users w-5"></i> Terceiros</button>
                <button onclick="switchTab('config')" class="nav-btn flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50"><i class="fa-solid fa-cog w-5"></i> Configura√ß√µes</button>
            </div>
            
            <div class="p-4 border-t border-gray-100 hidden md:block">
                <div class="flex items-center gap-3 mb-3 px-2">
                    <img id="userPhoto" src="" class="w-8 h-8 rounded-full bg-gray-200">
                    <div class="overflow-hidden">
                        <p id="userName" class="text-sm font-medium text-gray-700 truncate">Usu√°rio</p>
                        <p class="text-[10px] text-gray-400">Online</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full text-xs text-red-500 hover:bg-red-50 py-2 rounded border border-red-100">Sair da Conta</button>
            </div>
        </nav>

        <!-- Main Area -->
        <main class="flex-1 overflow-y-auto overflow-x-hidden relative w-full flex flex-col">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 sticky top-0 z-10 px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-3 shadow-sm">
                <div class="w-full md:w-auto">
                    <select id="globalCardFilter" onchange="renderAll()" class="w-full md:w-48 bg-gray-50 border border-gray-300 text-sm rounded-lg p-2 outline-none">
                        <option value="all">Todos os Cart√µes</option>
                    </select>
                </div>
                <div class="flex items-center bg-gray-100 rounded-lg p-1">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-white rounded text-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="currentDateDisplay" class="mx-2 font-semibold text-gray-700 w-32 text-center text-sm">---</span>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-white rounded text-gray-600"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <button onclick="openModal()" class="hidden md:flex bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm gap-2 items-center"><i class="fa-solid fa-plus"></i> Nova</button>
            </header>

            <!-- Tabs Content -->
            <div class="p-4 md:p-8 max-w-7xl mx-auto w-full pb-24 md:pb-8 flex-1">
                
                <!-- DASHBOARD -->
                <div id="tab-dashboard" class="tab-content space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <i class="fa-solid fa-file-invoice-dollar text-6xl absolute right-0 top-0 p-4 opacity-10 text-indigo-600"></i>
                            <p class="text-xs font-medium text-gray-500 uppercase">Fatura Atual</p>
                            <h3 id="totalInvoice" class="text-2xl font-bold text-gray-800 mt-1">R$ 0,00</h3>
                            <div class="mt-2 text-xs text-gray-400 flex justify-between"><span id="limitDisplay">Limite: R$ 0</span><span id="limitPercent">0%</span></div>
                            <div class="w-full bg-gray-100 rounded-full h-1 mt-1"><div id="limitBar" class="bg-indigo-500 h-1 rounded-full" style="width: 0%"></div></div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <i class="fa-solid fa-wallet text-6xl absolute right-0 top-0 p-4 opacity-10 text-emerald-600"></i>
                            <p class="text-xs font-medium text-gray-500 uppercase">Meus Gastos</p>
                            <h3 id="totalPersonal" class="text-2xl font-bold text-gray-800 mt-1">R$ 0,00</h3>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 mt-4"><div id="personalBar" class="bg-emerald-500 h-1.5 rounded-full" style="width: 0%"></div></div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <i class="fa-solid fa-hand-holding-dollar text-6xl absolute right-0 top-0 p-4 opacity-10 text-orange-500"></i>
                            <p class="text-xs font-medium text-gray-500 uppercase">A Receber</p>
                            <h3 id="totalOthers" class="text-2xl font-bold text-orange-600 mt-1">R$ 0,00</h3>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h4 class="font-semibold text-gray-700 mb-4">Divis√£o por Pessoa</h4>
                            <div id="peopleListSummary" class="space-y-3 max-h-60 overflow-y-auto no-scrollbar"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 lg:col-span-2">
                            <h4 class="font-semibold text-gray-700 mb-4">Maiores Gastos</h4>
                            <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="topExpensesTable"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- TRANSACTIONS (CORRIGIDO) -->
                <div id="tab-transactions" class="tab-content hidden space-y-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4 gap-4">
                            <h3 class="font-bold text-gray-700">Extrato</h3>
                            <!-- Input de Busca com evento oninput -->
                            <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Buscar..." class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full md:w-48 outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-3 py-3">Dia</th>
                                        <th class="px-3 py-3">Descri√ß√£o</th>
                                        <th class="px-3 py-3">Quem</th>
                                        <th class="px-3 py-3 text-center">Parc.</th>
                                        <th class="px-3 py-3 text-right">Valor</th>
                                        <th class="px-3 py-3 text-center">Apagar</th>
                                    </tr>
                                </thead>
                                <tbody id="fullTransactionsTable" class="divide-y divide-gray-100">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PEOPLE (COM RELAT√ìRIO) -->
                <div id="tab-people" class="tab-content hidden space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                        <h3 class="font-bold text-gray-700 mb-4">Pessoas & Relat√≥rios</h3>
                        <div class="flex gap-2 mb-6"><input type="text" id="newPersonName" placeholder="Nome" class="flex-1 border rounded px-3 py-2"><button onclick="addPerson()" class="bg-indigo-600 text-white px-4 rounded">Add</button></div>
                        <ul id="peopleListManage" class="divide-y divide-gray-100"></ul>
                    </div>
                </div>

                <!-- CONFIG -->
                <div id="tab-config" class="tab-content hidden space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                        <h3 class="font-bold text-gray-700 mb-4">Cart√µes</h3>
                        <form onsubmit="handleAddCard(event)" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 bg-gray-50 p-3 rounded border">
                            <input type="text" name="cardName" required placeholder="Nome" class="col-span-2 border rounded p-1 text-sm">
                            <input type="number" name="closingDay" required placeholder="Fecha" class="border rounded p-1 text-sm">
                            <input type="number" name="dueDay" required placeholder="Vence" class="border rounded p-1 text-sm">
                            <input type="number" name="limit" required placeholder="Limite" class="col-span-3 border rounded p-1 text-sm">
                            <button type="submit" class="bg-indigo-600 text-white rounded p-1"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        <div id="cardsList" class="space-y-2"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto mt-4">
                        <h3 class="font-bold text-gray-700 mb-2">Conta</h3>
                         <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Sair da aplica√ß√£o</span>
                            <button onclick="logout()" class="text-red-600 text-sm font-semibold border border-red-200 px-3 py-1 rounded">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- FAB -->
        <button onclick="openModal()" class="md:hidden fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl z-40"><i class="fa-solid fa-plus"></i></button>
    </div>

    <!-- MODAL NOVA TRANSA√á√ÉO -->
    <div id="transactionModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"><h3 class="font-bold text-gray-800">Nova Despesa</h3><button onclick="closeModal()" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
            <form id="transactionForm" onsubmit="handleTransactionSubmit(event)" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-2 bg-gray-100 p-1 rounded"><label class="cursor-pointer text-center"><input type="radio" name="type" value="one-time" class="hidden peer" checked onchange="toggleInstallmentField()"><div class="py-2 text-sm text-gray-500 rounded peer-checked:bg-white peer-checked:text-indigo-600 shadow-sm">√önica</div></label><label class="cursor-pointer text-center"><input type="radio" name="type" value="installment" class="hidden peer" onchange="toggleInstallmentField()"><div class="py-2 text-sm text-gray-500 rounded peer-checked:bg-white peer-checked:text-indigo-600 shadow-sm">Parcelada</div></label><label class="cursor-pointer text-center col-span-2"><input type="radio" name="type" value="subscription" class="hidden peer" onchange="toggleInstallmentField()"><div class="py-1 text-xs text-gray-500 rounded peer-checked:text-purple-600">Assinatura</div></label></div>
                <input type="text" name="description" required placeholder="Descri√ß√£o" class="w-full border rounded px-3 py-2 text-sm">
                <div class="grid grid-cols-2 gap-4"><input type="number" step="0.01" name="amount" required placeholder="Valor" class="w-full border rounded px-3 py-2 text-sm"><div id="installmentField" class="hidden"><input type="number" name="installments" min="2" max="48" value="2" class="w-full border rounded px-3 py-2 text-sm"></div></div>
                <div class="grid grid-cols-2 gap-4"><input type="date" name="date" required class="w-full border rounded px-3 py-2 text-sm"><select name="cardId" id="modalCardSelect" class="w-full border rounded px-3 py-2 text-sm"></select></div>
                <select id="modalPersonSelect" name="person" class="w-full border rounded px-3 py-2 text-sm"></select>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded shadow-lg">Salvar</button>
            </form>
        </div>
    </div>

    <!-- MODAL RELAT√ìRIO (NOVO) -->
    <div id="reportModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md h-[80vh] flex flex-col">
            <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center rounded-t-xl">
                <div>
                    <h3 class="font-bold text-white text-lg" id="reportTitle">Extrato de Pessoa</h3>
                    <p class="text-indigo-200 text-xs" id="reportSubtitle">M√™s Selecionado</p>
                </div>
                <button onclick="closeReport()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="reportContent">
                <!-- Conte√∫do gerado dinamicamente -->
            </div>

            <div class="p-4 bg-white border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-600 font-medium">Total a Pagar</span>
                    <span class="text-2xl font-bold text-gray-800" id="reportTotal">R$ 0,00</span>
                </div>
                <button onclick="copyReportToWhatsapp()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-3 rounded-lg shadow flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i class="fa-brands fa-whatsapp text-xl"></i> Copiar para WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBdFVQdYsdeMY3t1VjEAqC51pK4OZ-CuXM",
            authDomain: "cardmanager-3f955.firebaseapp.com",
            projectId: "cardmanager-3f955",
            storageBucket: "cardmanager-3f955.firebasestorage.app",
            messagingSenderId: "775728781858",
            appId: "1:775728781858:web:f51a1a94bad62a4031887b"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence().catch(err => console.log("Persistence err", err.code));

        // --- STATE ---
        let state = {
            user: null,
            transactions: [],
            people: ['Eu'],
            cards: [],
            viewDate: new Date(),
            currentTab: 'dashboard',
            selectedCardFilter: 'all',
            activeMonthTransactions: [] // Cache para busca
        };

        // --- AUTH ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                state.user = user;
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appLoading').classList.remove('hidden');
                subscribeToData(user.uid);
            } else {
                state.user = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appContent').classList.add('hidden');
                document.getElementById('appLoading').classList.add('hidden');
            }
        });
        function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => document.getElementById('loginStatus').innerText = e.message); }
        function logout() { auth.signOut(); location.reload(); }

        // --- SYNC ---
        function subscribeToData(uid) {
            db.collection('users').doc(uid).collection('transactions').onSnapshot((snap) => {
                state.transactions = [];
                snap.forEach(doc => state.transactions.push({ id: doc.id, ...doc.data() }));
                renderAll();
                document.getElementById('appLoading').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
            });
            db.collection('users').doc(uid).collection('config').doc('main').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    state.cards = data.cards || [];
                    state.people = data.people || ['Eu'];
                } else if (state.cards.length === 0) {
                    // Defaults
                    db.collection('users').doc(uid).collection('config').doc('main').set({
                        cards: [{ id: 'default', name: 'Meu Cart√£o', closingDay: 1, dueDay: 10, limit: 1000 }],
                        people: ['Eu']
                    });
                }
                renderAll();
            });
        }

        // --- DB OPS ---
        async function saveTransaction(data) { await db.collection('users').doc(state.user.uid).collection('transactions').add(data); closeModal(); }
        async function deleteTransactionDB(id) { if(confirm('Apagar?')) await db.collection('users').doc(state.user.uid).collection('transactions').doc(id).delete(); }
        async function saveSettings() { await db.collection('users').doc(state.user.uid).collection('config').doc('main').set({ cards: state.cards, people: state.people }); }

        // --- HANDLERS ---
        function handleTransactionSubmit(e) {
            e.preventDefault(); const f = new FormData(e.target);
            saveTransaction({
                type: f.get('type'), description: f.get('description'), amount: parseFloat(f.get('amount')),
                installments: f.get('type')==='installment'?parseInt(f.get('installments')):1, date: f.get('date'),
                cardId: f.get('cardId'), person: f.get('person'), createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        function handleAddCard(e) { e.preventDefault(); state.cards.push({ id: Date.now().toString(), name: e.target.cardName.value, closingDay: parseInt(e.target.closingDay.value), dueDay: parseInt(e.target.dueDay.value), limit: parseFloat(e.target.limit.value) }); saveSettings(); e.target.reset(); }
        function deleteCard(id) { if(state.cards.length<=1)return alert('Min 1 cart√£o'); state.cards = state.cards.filter(c=>c.id!==id); saveSettings(); }
        function addPerson() { const v = document.getElementById('newPersonName').value.trim(); if(v && !state.people.includes(v)){ state.people.push(v); saveSettings(); document.getElementById('newPersonName').value=''; } }
        function removePerson(n) { if(confirm('Remover '+n+'?')) { state.people = state.people.filter(p=>p!==n); saveSettings(); } }

        // --- CALC LOGIC ---
        function getFirstInstallmentDate(purchaseDateStr, closingDay) {
            const pDate = new Date(purchaseDateStr);
            let targetMonth = pDate.getUTCMonth(); let targetYear = pDate.getUTCFullYear();
            if (pDate.getUTCDate() >= parseInt(closingDay)) { targetMonth++; if(targetMonth>11){targetMonth=0;targetYear++;} }
            return { month: targetMonth, year: targetYear };
        }
        function getTransactionDetailsForMonth(transaction, viewDate) {
            const card = state.cards.find(c => c.id === transaction.cardId) || state.cards[0];
            if (!card) return { isActive: false };
            const firstBill = getFirstInstallmentDate(transaction.date, card.closingDay);
            const monthDiff = (viewDate.getFullYear() - firstBill.year) * 12 + (viewDate.getMonth() - firstBill.month);
            let isActive = false, currInst = '', amt = 0;
            if (transaction.type === 'subscription') { if(monthDiff>=0){ isActive=true; amt=transaction.amount; currInst='Assinatura'; } }
            else { const tot = transaction.type==='one-time'?1:transaction.installments; if(monthDiff>=0 && monthDiff<tot){ isActive=true; currInst=`${monthDiff+1}/${tot}`; amt=transaction.amount/tot; } }
            return { isActive, currentInstallment: currInst, installmentAmount: amt, cardName: card.name, originalDate: transaction.date };
        }

        // --- RENDER ---
        function renderAll() {
            renderCardSelects();
            renderDashboard();
            renderConfigCards();
            renderPeopleList();
        }

        function renderDashboard() {
            const globalFilter = document.getElementById('globalCardFilter').value;
            state.selectedCardFilter = globalFilter;
            let totalInvoice = 0, totalPersonal = 0, totalOthers = 0, totalLimit = 0;
            
            if (globalFilter === 'all') totalLimit = state.cards.reduce((acc, c) => acc + parseFloat(c.limit), 0);
            else { const c = state.cards.find(x => x.id === globalFilter); totalLimit = c ? parseFloat(c.limit) : 0; }

            const debtsByPerson = {};
            state.people.forEach(p => { if(p !== 'Eu') debtsByPerson[p] = 0; });
            
            // Filtra transa√ß√µes ativas para o m√™s
            state.activeMonthTransactions = [];

            state.transactions.forEach(t => {
                if (globalFilter !== 'all' && t.cardId !== globalFilter) return;
                const details = getTransactionDetailsForMonth(t, state.viewDate);
                if (details.isActive) {
                    const amount = details.installmentAmount;
                    totalInvoice += amount;
                    if (t.person === 'Eu') totalPersonal += amount;
                    else { totalOthers += amount; if (!debtsByPerson[t.person]) debtsByPerson[t.person] = 0; debtsByPerson[t.person] += amount; }
                    
                    state.activeMonthTransactions.push({ 
                        ...t, 
                        displayInstallment: details.currentInstallment, 
                        displayAmount: amount, 
                        cardName: details.cardName,
                        originalDate: details.originalDate
                    });
                }
            });

            document.getElementById('totalInvoice').textContent = formatMoney(totalInvoice);
            document.getElementById('totalPersonal').textContent = formatMoney(totalPersonal);
            document.getElementById('totalOthers').textContent = formatMoney(totalOthers);
            document.getElementById('limitDisplay').textContent = `Limite: ${formatMoney(totalLimit)}`;
            document.getElementById('limitBar').style.width = totalLimit>0 ? `${Math.min((totalInvoice/totalLimit)*100,100)}%` : '0%';

            const peopleEl = document.getElementById('peopleListSummary'); peopleEl.innerHTML = '';
            Object.entries(debtsByPerson).forEach(([name, val]) => {
                if(val > 0) peopleEl.innerHTML += `<div class="flex justify-between p-2 text-sm"><span class="text-gray-600">${name}</span><span class="font-bold text-orange-600">${formatMoney(val)}</span></div>`;
            });

            // Ordena e mostra Top 5
            state.activeMonthTransactions.sort((a, b) => b.displayAmount - a.displayAmount);
            const topTable = document.getElementById('topExpensesTable'); topTable.innerHTML = '';
            state.activeMonthTransactions.slice(0, 5).forEach(t => {
                topTable.innerHTML += `<tr class="border-b"><td class="py-2 truncate max-w-[120px]">${t.description}</td><td class="text-xs text-gray-500">${t.cardName}</td><td class="text-right font-bold">${formatMoney(t.displayAmount)}</td></tr>`;
            });

            // Chama a renderiza√ß√£o da tabela de transa√ß√µes (agora usando a lista processada)
            renderTransactionsList();
        }

        // --- BUSCA CORRIGIDA ---
        function handleSearch() {
            renderTransactionsList();
        }

        function renderTransactionsList() {
            const table = document.getElementById('fullTransactionsTable');
            table.innerHTML = '';
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            // Usa activeMonthTransactions que j√° foi calculado no Dashboard
            const filtered = state.activeMonthTransactions.filter(t => 
                t.description.toLowerCase().includes(term) || 
                t.person.toLowerCase().includes(term)
            );
            
            if (filtered.length === 0) {
                table.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">Nenhum registro encontrado.</td></tr>';
                return;
            }

            // Ordenar por data de compra original
            filtered.sort((a,b) => new Date(a.originalDate) - new Date(b.originalDate));

            filtered.forEach(t => {
                const day = new Date(t.originalDate).getUTCDate().toString().padStart(2, '0');
                table.innerHTML += `
                    <tr class="hover:bg-gray-50 bg-white border-b">
                        <td class="p-3 text-gray-500">${day}</td>
                        <td class="p-3">
                            <div class="font-medium text-gray-800">${t.description}</div>
                            <div class="text-xs text-gray-400">${t.cardName}</div>
                        </td>
                        <td class="p-3 text-center"><span class="px-2 py-0.5 rounded text-xs ${t.person==='Eu'?'bg-emerald-100 text-emerald-800':'bg-orange-100 text-orange-800'}">${t.person}</span></td>
                        <td class="p-3 text-center text-xs text-gray-500">${t.displayInstallment}</td>
                        <td class="p-3 text-right font-bold text-gray-700">${formatMoney(t.displayAmount)}</td>
                        <td class="p-3 text-center"><button onclick="deleteTransactionDB('${t.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        // --- RELAT√ìRIOS INDIVIDUAIS (NOVO) ---
        let currentReportData = { person: '', total: 0, items: [] };

        function openReport(personName) {
            const modal = document.getElementById('reportModal');
            const content = document.getElementById('reportContent');
            const monthName = state.viewDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            document.getElementById('reportTitle').textContent = `Extrato: ${personName}`;
            document.getElementById('reportSubtitle').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            
            // Filtra gastos da pessoa no m√™s ATUAL (via activeMonthTransactions)
            const personItems = state.activeMonthTransactions.filter(t => t.person === personName);
            
            // Ordenar por data
            personItems.sort((a,b) => new Date(a.originalDate) - new Date(b.originalDate));

            let total = 0;
            content.innerHTML = '';
            
            if (personItems.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-400 py-10">Nenhum gasto neste m√™s.</div>';
            } else {
                personItems.forEach(t => {
                    total += t.displayAmount;
                    const dateObj = new Date(t.originalDate);
                    const dateStr = `${dateObj.getUTCDate()}/${dateObj.getUTCMonth()+1}`;
                    
                    content.innerHTML += `
                        <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200 mb-2 shadow-sm">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-mono bg-gray-100 px-1.5 rounded text-gray-500">${dateStr}</span>
                                    <span class="font-semibold text-gray-800">${t.description}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${t.cardName} ‚Ä¢ Parcela ${t.displayInstallment}
                                </div>
                            </div>
                            <div class="font-bold text-gray-800">${formatMoney(t.displayAmount)}</div>
                        </div>
                    `;
                });
            }

            document.getElementById('reportTotal').textContent = formatMoney(total);
            modal.classList.remove('hidden');

            // Save data for copy functionality
            currentReportData = { person: personName, total: total, items: personItems, month: monthName };
        }

        function closeReport() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        function copyReportToWhatsapp() {
            const d = currentReportData;
            if (d.items.length === 0) return alert('Nada para copiar.');

            let text = `*Fatura de ${d.person} - ${d.month}*\n\n`;
            d.items.forEach(t => {
                const dateObj = new Date(t.originalDate);
                const dateStr = `${dateObj.getUTCDate()}/${dateObj.getUTCMonth()+1}`;
                text += `üóì ${dateStr} - ${t.description} (${t.displayInstallment})\nüí∞ ${formatMoney(t.displayAmount)}\n\n`;
            });
            text += `*TOTAL A PAGAR: ${formatMoney(d.total)}*`;

            navigator.clipboard.writeText(text).then(() => {
                alert('Relat√≥rio copiado! Cole no WhatsApp.');
            }).catch(() => {
                alert('Erro ao copiar. Selecione o texto manualmente.');
            });
        }

        // --- RENDER UTILS ---
        function renderCardSelects() {
            const gf = document.getElementById('globalCardFilter'); const cur = state.selectedCardFilter;
            gf.innerHTML = '<option value="all">Todos os Cart√µes</option>';
            state.cards.forEach(c => gf.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            gf.value = cur;
            const ms = document.getElementById('modalCardSelect'); ms.innerHTML = '';
            state.cards.forEach(c => ms.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }
        function renderConfigCards() {
            const list = document.getElementById('cardsList'); list.innerHTML = '';
            state.cards.forEach(c => list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded border mb-1"><div><div class="font-bold text-sm">${c.name}</div><div class="text-xs text-gray-500">Fecha ${c.closingDay} ‚Ä¢ Vence ${c.dueDay}</div></div><button onclick="deleteCard('${c.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div>`);
        }
        function renderPeopleList() {
            const sel = document.getElementById('modalPersonSelect'); sel.innerHTML = '';
            state.people.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            
            const list = document.getElementById('peopleListManage'); list.innerHTML = '';
            state.people.forEach(p => { 
                if(p !== 'Eu') {
                    // Adicionei bot√£o de relat√≥rio aqui
                    list.innerHTML += `
                    <li class="flex justify-between items-center p-3 border-b text-sm bg-gray-50 rounded mb-1">
                        <span class="font-medium text-gray-700">${p}</span>
                        <div class="flex gap-3">
                            <button onclick="openReport('${p}')" class="text-indigo-600 hover:text-indigo-800 flex items-center gap-1" title="Gerar Extrato">
                                <i class="fa-solid fa-clipboard-list text-lg"></i>
                            </button>
                            <button onclick="removePerson('${p}')" class="text-red-400 hover:text-red-600" title="Apagar Pessoa">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </li>`;
                }
            });
        }

        // --- UTILS GERAIS ---
        function switchTab(id) {
            state.currentTab = id;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.className = btn.className.replace('bg-indigo-600 text-white', 'text-gray-600 hover:bg-gray-50'));
            const active = document.querySelector(`button[onclick="switchTab('${id}')"]`);
            if(active) active.className = active.className.replace('text-gray-600 hover:bg-gray-50', 'bg-indigo-600 text-white');
            document.getElementById('navMenu').classList.add('hidden');
        }
        document.getElementById('mobileMenuBtn').addEventListener('click', () => document.getElementById('navMenu').classList.toggle('hidden'));
        function changeMonth(o) { state.viewDate.setMonth(state.viewDate.getMonth() + o); updateDateDisplay(); renderAll(); }
        function updateDateDisplay() { const s = state.viewDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }); document.getElementById('currentDateDisplay').textContent = s.charAt(0).toUpperCase() + s.slice(1); }
        function formatMoney(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function openModal() { document.getElementById('transactionModal').classList.remove('hidden'); document.querySelector('input[name="date"]').value = new Date().toISOString().split('T')[0]; }
        function closeModal() { document.getElementById('transactionModal').classList.add('hidden'); document.getElementById('transactionForm').reset(); }
        function toggleInstallmentField() { const t = document.querySelector('input[name="type"]:checked').value; const f = document.getElementById('installmentField'); t === 'installment' ? f.classList.remove('hidden') : f.classList.add('hidden'); }
        
        updateDateDisplay();
    </script>
</body>
</html>